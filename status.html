<!DOCTYPE html>
<html>
<head>
    <title>Autoware 실시간 데이터 그래프</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 1. [수정] 가상 마우스 효과 (커서 변경) 추가 */
        body { 
            font-family: Arial, sans-serif; 
            cursor: crosshair; /* 페이지 기본 커서를 십자 모양으로 변경 */
        }
        .chart-container {
            width: 80%; 
            margin: 20px auto;
        }
        /* 차트와 버튼 위에서는 손가락 모양으로 */
        #autowareSpeedChart, .key {
             cursor: pointer;
        }
        
        #lastUpdateTime {
            text-align: center;
            font-size: 0.9em;
            color: #666;
        }

        /* 2. [추가] 가상 키보드 스타일 */
        #keyboard-section {
            width: 80%;
            margin: 30px auto; /* 위쪽 차트와 간격 띄우기 */
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #ddd; /* 구분선 */
        }
        #virtual-input {
            width: 300px;
            font-size: 1.2em;
            padding: 5px;
            margin-bottom: 15px;
        }
        #keyboard-container {
            display: flex;
            justify-content: center; /* 버튼들 가운데 정렬 */
            gap: 10px; /* 버튼 사이 간격 */
        }
        .key {
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: bold;
            border: 1px solid #ccc;
            background-color: #f4f4f4;
            border-radius: 5px;
            transition: background-color 0.2s;
            user-select: none; /* 텍스트 선택 방지 */
        }
        .key:hover {
            background-color: #e0e0e0;
        }
        .key.backspace {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Autoware 차량 실시간 데이터</h1>
    
    <div class="chart-container">
        <canvas id="autowareSpeedChart"></canvas>
        <p id="lastUpdateTime">마지막 업데이트: 로딩 중...</p>
    </div>

    <div id="keyboard-section">
        <h2>가상 키보드 입력</h2>
        <input type="text" id="virtual-input" placeholder="아래 버튼으로 입력...">
        
        <div id="keyboard-container">
            <button class="key">Q</button>
            <button class="key">W</button>
            <button class="key">E</button>
            <button class="key">R</button>
            <button class="key">T</button>
            <button class="key backspace">← 지우기</button>
        </div>
    </div>


    <script>
        // =============================================
        // === 1. 기존 차트 스크립트 (수정 없음) ===
        // =============================================
        let speedChart; // 그래프 객체를 저장할 전역 변수
        
        // 1. Cloudflare 프록시(🌩️) 주소
        const FLASK_API_BASE_URL = 'https://api.fml1.store';

        
        // 5초마다 API를 호출하여 데이터를 갱신하고 그래프를 다시 그리는 함수
        function fetchAndDrawGraph() {
            
            // 🚨 2. [수정 완료] Flask 서버의 전체 API 경로로 요청
            // (https://api.fml1.store/api/autoware)
            fetch(FLASK_API_BASE_URL + '/api/autoware') 
                .then(response => {
                    if (!response.ok) {
                        // 404, 500 등 서버 응답 오류 처리
                        throw new Error(`HTTP 오류! 서버 상태: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const labels = data.labels;
                    const speedValues = data.speed;

                    // 3. [오타 수정] '2d'
                    const ctx = document.getElementById('autowareSpeedChart').getContext('2d'); 
                    
                    if (speedChart) {
                        // 기존 그래프가 있으면 데이터를 갱신합니다.
                        speedChart.data.labels = labels;
                        speedChart.data.datasets[0].data = speedValues;
                        speedChart.update(); // 그래프 업데이트 명령
                    } else {
                        // 최초 로드 시 그래프를 생성합니다.
                        speedChart = new Chart(ctx, {
                            type: 'line', 
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: '차량 속도 (m/s)',
                                    data: speedValues,
                                    backgroundColor: 'rgba(255, 99, 132, 0.4)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 2,
                                    tension: 0.1, // 부드러운 선
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                animation: {
                                    duration: 0 // 업데이트 시 애니메이션을 끔
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: '속도 (m/s)'
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // 마지막 업데이트 시간 표시
                    document.getElementById('lastUpdateTime').textContent = '마지막 업데이트: ' + new Date().toLocaleTimeString('ko-KR');

                })
                .catch(error => {
                    // 네트워크 오류 또는 CORS 오류 시 메시지 표시
                    console.error('데이터 로드 오류:', error);
                    document.getElementById('lastUpdateTime').innerHTML = `<span style="color:red;">데이터 로드 실패: ${error.message} (서버 주소 및 방화벽 확인)</span>`;
                });
        }

        // 4. 페이지 로드 시 즉시 실행
        fetchAndDrawGraph();

        // 5. 2초(2000ms)마다 자동으로 데이터를 갱신
        setInterval(fetchAndDrawGraph, 2000); 
    </script>
</body>
</html>
